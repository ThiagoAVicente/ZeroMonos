<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ServiceRequestService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HW1</a> &gt; <a href="index.source.html" class="el_package">org.hw1.service</a> &gt; <span class="el_source">ServiceRequestService.java</span></div><h1>ServiceRequestService.java</h1><pre class="source lang-java linenums">package org.hw1.service;

import org.hw1.data.Status;
import org.hw1.data.Municipality;
import org.hw1.data.ServiceRequest;
import org.hw1.data.ServiceStatusHistory;
import org.hw1.data.User;
import org.hw1.data.ServiceRequestRepository;
import org.hw1.data.ServiceStatusHistoryRepository;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.time.LocalDate;
import java.time.LocalTime;
import java.util.List;
import java.util.Optional;

@Service
<span class="fc" id="L20">public class ServiceRequestService {</span>

    @Autowired
    private ServiceRequestRepository serviceRequestRepository;

    @Autowired
    private ServiceStatusHistoryRepository serviceStatusHistoryRepository;

	private static final int MAX_REQUESTS_PER_USER = 5;

	public ServiceRequest createServiceRequest(User user, Municipality municipality, LocalDate requestedDate, LocalTime timeSlot, String description) {
<span class="fc" id="L31">	    ServiceRequest request = new ServiceRequest();</span>
<span class="fc" id="L32">        request.setUser(user);</span>
<span class="fc" id="L33">        request.setMunicipality(municipality);</span>
<span class="fc" id="L34">        request.setRequestedDate(requestedDate);</span>
<span class="fc" id="L35">        request.setTimeSlot(timeSlot);</span>
<span class="fc" id="L36">        request.setDescription(description);</span>
        // generate unique token
<span class="fc" id="L38">        String token = java.util.UUID.randomUUID().toString();</span>
<span class="fc" id="L39">        request.setToken(token);</span>

<span class="fc bfc" id="L41" title="All 2 branches covered.">        if (!isAvailable(municipality, requestedDate, timeSlot)) {</span>
<span class="fc" id="L42">            return null;</span>
        }
<span class="fc" id="L44">        ServiceRequest r = serviceRequestRepository.save(request);</span>
<span class="fc" id="L45">        addStatusHistoryEntry(r, Status.RECEIVED);</span>
<span class="fc" id="L46">        return r;</span>

    }

    public Optional&lt;ServiceRequest&gt; getServiceRequestByToken(String token) {
<span class="fc" id="L51">        return serviceRequestRepository.findByToken(token);</span>
    }

    public void cancelServiceRequest(String token) throws Exception {
        // check if request exists
<span class="fc" id="L56">        ServiceRequest request = serviceRequestRepository.findByToken(token)</span>
<span class="pc" id="L57">            .orElseThrow(() -&gt; new Exception(&quot;Service request not found&quot;));</span>

        // update status to CANCELLED
<span class="fc" id="L60">        addStatusHistoryEntry(request, Status.CANCELLED);</span>

<span class="fc" id="L62">    }</span>

    public List&lt;ServiceStatusHistory&gt; getServiceStatusHistory(String token) throws Exception {
<span class="fc" id="L65">        ServiceRequest request = serviceRequestRepository.findByToken(token)</span>
<span class="pc" id="L66">            .orElseThrow(() -&gt; new Exception(&quot;Service request not found&quot;));</span>

<span class="fc" id="L68">        return serviceStatusHistoryRepository.findByServiceRequestOrderByCreatedAtDesc(request);</span>

    }

    public void updateServiceRequestStatus(String token, Status newStatus) throws Exception {
<span class="fc" id="L73">        ServiceRequest request = serviceRequestRepository.findByToken(token)</span>
<span class="pc" id="L74">            .orElseThrow(() -&gt; new Exception(&quot;Service request not found&quot;));</span>

<span class="fc" id="L76">        addStatusHistoryEntry(request, newStatus);</span>
<span class="fc" id="L77">    }</span>

    public List&lt;ServiceRequest&gt; getServiceRequestsByMunicipality(Municipality municipality) {
<span class="fc" id="L80">        return serviceRequestRepository.findByMunicipality(municipality);</span>
    }

    public List&lt;ServiceRequest&gt; getServiceRequestsByUser(User user) {
        // check if user exists
<span class="fc" id="L85">        return serviceRequestRepository.findByUserId(user.getId());</span>
    }

    public void addStatusHistoryEntry(ServiceRequest request, Status status) {
<span class="fc" id="L89">        ServiceStatusHistory history = new ServiceStatusHistory();</span>
<span class="fc" id="L90">        history.setServiceRequest(request);</span>
<span class="fc" id="L91">        history.setStatus(status);</span>
<span class="fc" id="L92">        serviceStatusHistoryRepository.save(history);</span>
<span class="fc" id="L93">    }</span>

    public boolean isAvailable(Municipality municipality,
        LocalDate date,
        LocalTime time_slot){
        // check if is a sunday
<span class="fc bfc" id="L99" title="All 2 branches covered.">        if (date.getDayOfWeek().getValue() == 7) {</span>
<span class="fc" id="L100">            return false;</span>
        }

        // find all requests for the municipality at the given date
<span class="fc" id="L104">        List&lt;ServiceRequest&gt; requests = serviceRequestRepository.findByMunicipalityAndRequestedDate(municipality, date);</span>
        // check if there is any conflict. each time slot has an expected duration of 1 hour
<span class="fc" id="L106">        LocalTime before_max = time_slot.minusHours(1);</span>
<span class="fc" id="L107">        LocalTime after_max = time_slot.plusHours(1);</span>
<span class="fc bfc" id="L108" title="All 2 branches covered.">        for (ServiceRequest request : requests) {</span>
<span class="fc" id="L109">            LocalTime existingTimeSlot = request.getTimeSlot();</span>
<span class="fc" id="L110">            LocalTime existing_before_max = existingTimeSlot.minusHours(1);</span>
<span class="fc" id="L111">            LocalTime existing_after_max = existingTimeSlot.plusHours(1);</span>
<span class="pc bpc" id="L112" title="2 of 4 branches missed.">            boolean isTimeSlotConflict = (time_slot.isAfter(existing_before_max) &amp;&amp; time_slot.isBefore(existing_after_max));</span>
<span class="pc bpc" id="L113" title="2 of 4 branches missed.">            boolean isExistingSlotConflict = (existingTimeSlot.isAfter(before_max) &amp;&amp; existingTimeSlot.isBefore(after_max));</span>
<span class="pc bpc" id="L114" title="3 of 4 branches missed.">            if (isTimeSlotConflict || isExistingSlotConflict){</span>
<span class="fc" id="L115">                return false;</span>
            }

<span class="nc" id="L118">        }</span>
<span class="fc" id="L119">        return true;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>